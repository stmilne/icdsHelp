# Compiling source

Collab offers a broad range of installed open-source applications,
but sometimes you need an application Collab doesn’t have.
When that happens, ask the ICDS Help Desk to install it for you,
particularly if you can make a case that others will also use it.

If that doesn’t work, you may try installing the application yourself,
in your own work or group directory.
Depending on the application,
and how well its source package is designed and documented,
this can be relatively straightforward, or a total nightmare.

The nightmare scenarios involve poor documentation,
combined with the need for other packages also not installed on Collab,
which in turn need other packages, and so on.  So beware...

## wget

The first step is to get the source package (typically a tarball of some sort)
from the developer website onto Collab.
The easiest way to do this is with `wget`,
a command line tool for downloading such packages from the web.
```
wget <webAddress>
```
where `<webAddress>` can be copied from a browser link pointing to the file.

## cmake

Many if not most source packages are built using `cmake`,
a Unix tool for controlling the compile and load process.
To use `cmake`, first load its module:
```
module load cmake
```
To build from source, the typical procedure
is to `cd` into the source folder,
and execute in turn:
```
mkdir build
cd build
cmake <options>
make
make install
```
Here `<options>` is a list of options for `cmake`,
that may control what version of the software to build,
what assumptions to make about the CPU,
what packages to include,
and where to install the resulting executables.
Well-designed source packages include help files
that describe the various build options.

## Group access

If you want others to be able to use 
software that you build from source,
the executables and libraries generated by the build
must be placed in a directory that others can access.

The simplest way to achieve this 
is to place the executables in your group space.
Group space for a PI on Collab is located at
`/storage/group/<PIuserID>/default`,
which is read-accessible by members of `<PIuserID>_collab`.
Note however that if a PI makes an alias 
to their group space in their home directory,
with the command
```
ln -s group /storage/group/<PIuserID>/default
```
the path `/storage/home/<PIuserID>/group` 
is *not* accessible to others,
because their home directory `/storage/home/<PIuserID>`
is not accessible to others.


## Custom modules

To use software you have compiled from source,
it is convenient to make your own modulefile,
for which it is helpful to have an example.
Modulefiles on Collab are located primarily 
in `/storage/icds/RISE/sw8/modules`.

The contents of a modulefile are:

- "whatis" directives,
that supply information for `module info` and `module spider`;
- possibly some "load" commands 
to load other modules needed by the given module;
- changes to various path variables,
so the system can find the software.

Here is an example:

```
whatis([[Name : gromacs]])
whatis([[Version : 2024.3]])
whatis([[Target : haswell]])

whatis([[Description : GROMACS is a versatile molecular dynamics package.]])
whatis('URL: https://www.gromacs.org')

whatis([[Configure options: -DGMX_MPI=off 
-DCMAKE_INSTALL_PREFIX=/storage/icds/RISE/sw8/gromacs/gromacs-2024.3/install 
-DGMX_DOUBLE=off -DGMX_BUILD_OWN_FFTW=ON -DGMX_GPU=off]])

help([[This GROMACS version was built on 10/22/2024 on p-sc-2370, using the gcc
v13.2.0 compilers with openmpi v5.0.3 and cuda toolkit v12.6.2.]])

-- Local variables
local base = '/storage/icds/RISE/sw8/gromacs/gromacs-2024.3/install'

-- Additional modules
load('gcc/13.2.0')
load('cuda/12.6.2')
load('openmpi/5.0.3')

-- Take care of $PATH, $LD_LIBRARY_PATH, $MANPATH etc
prepend_path('PATH', pathJoin(base,'bin'))
prepend_path('MANPATH', pathJoin(base,'share/man'))
prepend_path('LD_LIBRARY_PATH', pathJoin(base,'lib64'))
prepend_path('LIBRARY_PATH', pathJoin(base,'lib64'))
prepend_path('C_INCLUDE_PATH', pathJoin(base,'include'))
prepend_path('CPLUS_INCLUDE_PATH', pathJoin(base,'include'))
prepend_path('CPATH', pathJoin(base,'include'))
prepend_path('PKG_CONFIG_PATH', pathJoin(base,'lib64/pkgconfig'))
```

To tell `module` where to find your custom modules,
add this line to your `.bashrc` file:
```
module use <module_directory>
```
in which `<module_directory>` is the path to your modules.

To make custom modules accessible to your group, 
place them in your group folder.
Group members should likewise include `module use...` in their `.bashrc` files.
